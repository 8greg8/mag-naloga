\section{Optični tok}
% Teorija optičnega toka
% vrste optičnega toka
% Kateri tip smo mi uporabili
% Zakaj smo tega uporabili
% Kako smo ga uporabili
% Problemi naše predpostavke
% Rešitev s kalibracijo velikosti
Za namen razlage upoštevamo perpektivni model kamere, kjer je \cite{trucco1998introductory}:

\begin{itemize}
\item \textbf{optična os} enaka $Z$ osi koordinatnega sistema kamere.
\item \textbf{Gibajoči masni delec} je predstavljen enako kot v poglavju \ref{sec:model-gibanja}.
\item \textbf{Osvetlitev} se ne spreminja.
\end{itemize}

Sliko delca $\vec{p} = [x~y]^\top$ na slikovni ravnini, kjer sta $x$ in $y$ slikovni koordinati, lahko predstavimo z enačbo

\begin{equation}\label{eq:slika-delca}
	\vec{p} = f \frac{\vec{P}}{Z},
\end{equation}

kjer je $f$ goriščna razdalja kamere \cite{trucco1998introductory}. S časovnim odvodom enačbe \eqref{eq:slika-delca}, dobimo hitrost delca na slikovni ravnini:

\begin{equation}\label{eq:hitrost-slike-delca}
	\vec{v} = f \frac{Z\vec{V}-V_Z\vec{P}}{Z^2}.
\end{equation}

Razširjena oblika enačbe \eqref{eq:hitrost-slike-delca}, kjer upoštevamo \eqref{eq:gibanje}, je zapisana z enačbo \eqref{eq:hitrost-slike-delca-raz} \cite{trucco1998introductory}. Prvi člen v posamezni enačbi predstavlja \textbf{translatorni del}, ostali členi pa sodijo v \textbf{rotacijski del}.

\begin{equation}\label{eq:hitrost-slike-delca-raz}
\begin{aligned}
	v_x = & \frac{T_Z x - T_X f}{Z} - \omega_Y f + \omega_Z y + \frac{\omega_X x y}{f} - \frac{\omega_Y x^2}{f} \\
    v_y = & \frac{T_Z y - T_Y f}{Z} - \omega_X f + \omega_Z x + \frac{\omega_Y x y}{f} - \frac{\omega_X y^2}{f}
\end{aligned}
\end{equation}

Kadar imamo na slikovni ravnini več slik delcev, množico vektorjev hitrosti $\vec{v}$ imenujemo \textbf{polje gibanja} (angl. Motion Field) \cite{trucco1998introductory}. Polje gibanja lahko razumemo kot projekcijo polja hitrosti na slikovno ravnino, zato ta predstavlja idealno rekonstrukcijo gibanja. V praksi do polja gibanja ne moremo dostopati, zato se poslužujemo njegovih približkov.  

Video posnetek je sestavljen iz sekvence slik, to pa lahko opišemo kot funkcijo osvetljenosti slikovnega elementa $I(\vec{x},t)$, na poziciji $\vec{x} = [x~y]^\top$ ob času $t$ \cite{wedel2011stereo}. Gibanje oseb opazimo kot premikanje pikslov skozi čas, pri čemer predpostavimo, da osvetljenost posameznega piklsa ostaja konstantnta \cite{trucco1998introductory}. Stacionarnost osvetljenosti slikovnega elementa lahko opišemo z enačbo  

\begin{equation}
	\frac{d I(\vec{x}, t)}{dt} = \frac{\partial I}{\partial x} \frac{dx}{dt} + \frac{\partial I}{\partial y} \frac{dy}{dt} + \frac{\partial I}{\partial t} = 0,
\end{equation}

to pa lahko zapišemo z vektorjem hitrosti slikovnega elementa $\vec{u}$ v kompaktnejšo obliko

\begin{equation}\label{eq:opticni-tok}
	(\nabla I)^\top \vec{u} + I_t = 0.
\end{equation}

Enačba \eqref{eq:opticni-tok} predstavlja omejitev \textbf{optičnega toka} \cite{trucco1998introductory}. Če v enačbi \eqref{eq:opticni-tok} normaliziramo prostorski gradient $(\nabla I)$, v enačbi \eqref{eq:aperture-problem} opazimo, da lahko  določimo le hitrost, ki je vzporedna prostorskemu gradientu. Pojav je znan kot problem reže (angl. Aperture problem) \cite{trucco1998introductory}. 

\begin{equation}\label{eq:aperture-problem}
	\frac{(\nabla I)^\top \vec{u}}{\| \nabla I \|} = - \frac{E_t}{\| \nabla I \|} = u_n
\end{equation}

Problem reže si lahko razlagamo na način opazovanja gibanja črne daljice na beli podlagi skozi režo tako, da ne vidimo koncev. Zaradi omejene vizualne informacije lahko določimo hitrost le v pravokotni smeri na daljico \cite{trucco1998introductory}. 

Kadar imamo na slikovni ravnini več premikajočih slikovnih elementov, vektorsko polje hitrosti $\vec{u}$ imenujemo \textbf{optični tok} (angl. Optical flow) \cite{trucco1998introductory}. Optični tok je dobra aproksimacija polja gibanja v točkah visokega prostorskega gradienta svetlosti in konstantne osvetlitve.



\subsection{Metode estimacije optičnega toka}

Metode estimacije optičnega toka v grobem delimo na diferencialne in {ujemalne} metode \cite{trucco1998introductory}. Z \textbf{diferencialnimi metodami} računamo optični tok z uporabo parcialnih diferencialnih enačb ali minimizacijskimi metodami. Z metodami dobimo \textbf{gost optični kot}, kar pomeni, da je optični tok določen za vsak slikovni element \cite{trucco1998introductory}. Te metode zelo natačno opisujejo optični tok in ne proizvajajo vrednosti, ki lokalno odstopajo, zato je optični tok gladek \cite{brox2011large}.  Glavni problem teh metod je, da so računsko zelo zahtevne \cite{trucco1998introductory}.

Pri \textbf{ujemalnih metodah} računamo optični tok le na značilnih točkah \cite{trucco1998introductory}. Zaradi uporabe značilk so te metode lahko bolj efektivne, saj ne potrebujemo določevanja korespondenc za vse piksle. Prav tako se lahko uporabijo za računanje optičnega toka v realnem času, saj niso računsko zahtevne. Po \cite{trucco1998introductory} je največja težava teh metod, da računajo \textbf{redek optični tok}, saj je ta določen le za slikovne elemete, ki predstavljajo značilne točke. Prav tako delujejo dobro le pri majhnih premikih, ker temeljijo na Taylorjevi aproksimaciji enačbe \eqref{eq:opticni-tok} \cite{wedel2011stereo}. 

Na podlagi zgoraj opisanih lastnosti smo se odločili, da bomo v tem delu uporabili diferencialno metodo. Kljub višji računski zahtevnosti, ki ob današnji tehnologiji ne predstavlja več takega problema, smo želeli računati gost optični tok. Z gostim optičnim tokom tako dobimo natačno aproksimacijo polja gibanja za celotno telo. Prav tako nimamo problemov pri estimaciji energijske porabe za hitre gibe, kot bi bilo to v primeru uporabe ujemlanih metod. Ker je glavni namen uporaba in ne implementacija diferencialne metode, smo se osredotočili na Farneb{\"a}ck algoritem, ki je dostopen v knjižnici OpenCV.

\paragraph{Farneb{\"a}ck algoritem.}
Alogritem temelji na estimaciji premika z razčlenjevanjem polinoma  po enačbi \eqref{eq:polinom}, kjer je $\vec{A}$ simetrična matrika, $\vec{b}$ vektor in $c$ skalar \cite{farneback2003two}.

\begin{equation}\label{eq:polinom}
	f(\vec{x}) \sim \vec{x}^\top \vec{A} \vec{x} + \vec{b}^\top \vec{x} + c
\end{equation}

Ideja temelji na tem, da aproksimiramo okolico piksla s kvadratičnim polinomom, pri čemer želimo najti premik piksla na poziciji $\vec{x}$ z minimizacijo enačbe \eqref{eq:polinom-min} in omejitvijo \eqref{eq:omejitev-polinoma}. $\vec{A}_1(\vec{x})$ in $\vec{b}_1(\vec{x})$ sta razčlenitvena koeficienta za prvo sliko, $\vec{A}_2(\vec{x})$ in $\vec{b}_2(\vec{x})$ koeficienta za drugo sliko in $w(\Delta\vec{x})$ je utežna funkcija za sosedne točke.

\begin{align}
\vec{A}(\vec{x}) = & \frac{\vec{A}_1(\vec{x} + \vec{A}_2(\vec{x}))}{2} \\
\Delta\vec{b}(\vec{x}) = & - \frac{1}{2}\left(\vec{b}_2(\vec{x}) - \vec{b}_1(\vec{x})\right) 
\end{align}

\begin{equation}\label{eq:polinom-min}
\sum_{\Delta x \in I} w(\Delta\vec{x}) \| \vec{A}(\vec{x} + \Delta\vec{x})\vec{d}(\vec{x}) - \Delta\vec{b}(\vec{x} +\Delta\vec{x}) \|^2
\end{equation}

\begin{equation}\label{eq:omejitev-polinoma}
\vec{A}(\vec{x})\vec{d}(\vec{x}) = \Delta\vec{b}(\vec{x})
\end{equation}

Rešitev minimizacije enačbe \eqref{eq:polinom-min} je enačba \eqref{eq:polinom-resitev}

\begin{equation}\label{eq:polinom-resitev}
 \vec{d}(\vec{x}) = \left( \sum w \vec{A}^\top \vec{a} \right)^{-1} \sum w \vec{A}^\top \Delta\vec{b}
\end{equation}

Evaluacija algoritma je bila narejena v \cite{Geiger2012CVPR}. Rezultati so povzeti v tabeli \ref{tab:farneback}. Algoritem so preverjali s procesorjem z 1 jedrom \@ \SI{2.5}{GHz}.

\begin{table}
	\centering
    \begin{tabular}{S[table-format=2.2] S[table-format=2.2] S[table-format=2.1] S[table-format=2.1] S[table-format=3.2] S[table-format=1]}
    \toprule
    \multicolumn{1}{c}{\textbf{Out-Noc}} & \multicolumn{1}{c}{\textbf{Out-All}} & \multicolumn{1}{c}{\textbf{Avg-Noc}} & \multicolumn{1}{c}{\textbf{Avg-All}} & \multicolumn{1}{c}{\textbf{Gostota}} & \multicolumn{1}{c}{\textbf{Čas izvajanja}} \\
    \midrule
    47.59~\% & 54.00~\% & 17.3~px & 25.3~px & 100.00~\% & 1~s\\
    \bottomrule
    \end{tabular}
    \caption[Evaluacija Farneb{\"a}ck algoritma v KITTI Vision Benchmark 2012]{Evaluacija Farneb{\"a}ck algoritma v KITTI Vision Benchmark 2012 \cite{Geiger2012CVPR}. Metrika Out-Noc predstavlja procent pikslov, ki težijo k napakam v območju, kjer ni prekrivnosti. Out-all je procent pikslov, ki težijo k napakam v celoti. Avg-Noc je povprečna napaka disparitete v območjih neprekrivnsoti. Avg-All je povprečna napaka disparitete v celoti. Gostota predstavlja procent pikslov, za katere je metoda določila referenco \cite{Geiger2012CVPR}.}
    \label{tab:farneback}
\end{table}




\section{Prostorski tok}
% Teorija prostorskega toka
% Katero metodo smo mi uporabili in zakaj

